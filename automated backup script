#!/bin/bash

# ============================
# Automated Backup Script
# ============================

# ------ User Configurable Settings ------
SOURCE_DIR="/path/to/source"         # Directory to back up
REMOTE_USER="username"               # Remote server username
REMOTE_HOST="remote.server.com"      # Remote server hostname/IP
REMOTE_DIR="/path/to/backup"         # Remote server storage directory

USE_S3=false                          # Set to true if using AWS S3
S3_BUCKET="s3://your-bucket-name"     # S3 bucket name

LOG_FILE="/var/log/backup.log"
TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
BACKUP_NAME="backup_$TIMESTAMP.tar.gz"

# ----------------------------------------

echo "================ BACKUP STARTED: $TIMESTAMP ================" | tee -a $LOG_FILE

# Step 1: Create tarball
echo "Creating backup archive..."
tar -czf /tmp/$BACKUP_NAME $SOURCE_DIR

if [ $? -ne 0 ]; then
    echo "ERROR: Failed to create backup archive!" | tee -a $LOG_FILE
    exit 1
fi

echo "Backup file created: /tmp/$BACKUP_NAME" | tee -a $LOG_FILE

# Step 2 (Option A): Transfer to Remote Server via SCP
echo "Transferring backup to remote server: $REMOTE_HOST"

scp /tmp/$BACKUP_NAME ${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_DIR}

if [ $? -eq 0 ]; then
    echo "SUCCESS: Backup transferred to remote server." | tee -a $LOG_FILE
    REMOTE_UPLOAD_SUCCESS=true
else
    echo "ERROR: Failed to transfer backup to remote server." | tee -a $LOG_FILE
    REMOTE_UPLOAD_SUCCESS=false
fi

# Step 3 (Option B): Upload to AWS S3
if [ "$USE_S3" = true ]; then
    echo "Uploading backup to AWS S3 bucket: $S3_BUCKET"
    
    aws s3 cp /tmp/$BACKUP_NAME $S3_BUCKET/

    if [ $? -eq 0 ]; then
        echo "SUCCESS: Backup uploaded to S3." | tee -a $LOG_FILE
        S3_UPLOAD_SUCCESS=true
    else
        echo "ERROR: Failed to upload backup to S3." | tee -a $LOG_FILE
        S3_UPLOAD_SUCCESS=false
    fi
fi

# Step 4: Cleanup local temp backup
rm -f /tmp/$BACKUP_NAME

# Final Report
echo "------------------------------------------------------------" | tee -a $LOG_FILE
echo "Backup Completed: $TIMESTAMP" | tee -a $LOG_FILE

if [ "$REMOTE_UPLOAD_SUCCESS" = true ]; then
    echo "Remote Server Upload: SUCCESS" | tee -a $LOG_FILE
else
    echo "Remote Server Upload: FAILED" | tee -a $LOG_FILE
fi

if [ "$USE_S3" = true ]; then
    if [ "$S3_UPLOAD_SUCCESS" = true ]; then
        echo "AWS S3 Upload: SUCCESS" | tee -a $LOG_FILE
    else
        echo "AWS S3 Upload: FAILED" | tee -a $LOG_FILE
    fi
fi

echo "================ BACKUP FINISHED ================" | tee -a $LOG_FILE
